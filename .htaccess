# Security Headers and HTTPS Enforcement
# This file works with Apache/XAMPP
# HTTPS enforcement is disabled for localhost to allow local development

# Enable Rewrite Engine
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Get the server name
    RewriteCond %{SERVER_NAME} ^localhost$ [OR]
    RewriteCond %{SERVER_NAME} ^127\.0\.0\.1$ [OR]
    RewriteCond %{SERVER_NAME} ^::1$ [OR]
    RewriteCond %{SERVER_NAME} ^192\.168\. [OR]
    RewriteCond %{SERVER_NAME} ^10\.0\. [OR]
    RewriteCond %{SERVER_NAME} ^172\.(1[6-9]|2[0-9]|3[0-1])\. 
    
    # If NOT localhost AND NOT HTTPS, redirect to HTTPS
    RewriteCond %{HTTPS} off
    RewriteCond %{SERVER_NAME} !^localhost$ [NC]
    RewriteCond %{SERVER_NAME} !^127\.0\.0\.1$ [NC]
    RewriteCond %{SERVER_NAME} !^::1$ [NC]
    RewriteCond %{SERVER_NAME} !^192\.168\. [NC]
    RewriteCond %{SERVER_NAME} !^10\.0\. [NC]
    RewriteCond %{SERVER_NAME} !^172\.(1[6-9]|2[0-9]|3[0-1])\. [NC]
    RewriteRule ^(.*)$ https://%{SERVER_NAME}%{REQUEST_URI} [R=301,L]
</IfModule>

# Security Headers
<IfModule mod_headers.c>
    # X-Frame-Options: Prevent clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"
    
    # X-Content-Type-Options: Prevent MIME type sniffing
    Header always set X-Content-Type-Options "nosniff"
    
    # X-XSS-Protection: Enable XSS filter
    Header always set X-XSS-Protection "1; mode=block"
    
    # Referrer-Policy: Control referrer information
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Permissions-Policy: Control browser features
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    
    # Remove server information
    Header always unset X-Powered-By
    Header unset X-Powered-By
    
    # HSTS (HTTP Strict Transport Security) - Only for HTTPS in production
    # Note: This is handled by PHP for better localhost detection
    # Uncomment below if you want Apache-level HSTS (but it won't detect localhost as well)
    # <If "%{HTTPS} == 'on' && %{SERVER_NAME} !~ /^(localhost|127\.0\.0\.1|::1|192\.168\.|10\.0\.|172\.(1[6-9]|2[0-9]|3[0-1])\.)/">
    #     Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    # </If>
</IfModule>

# Prevent directory browsing
Options -Indexes

# Protect sensitive files
<FilesMatch "^(\.htaccess|\.htpasswd|\.git|\.env|config\.php|SECURITY_VULNERABILITIES\.md)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Prevent access to PHP files in include directory (if accessed directly)
<IfModule mod_rewrite.c>
    RewriteCond %{REQUEST_URI} ^/include/.*\.php$ [NC]
    RewriteRule ^(.*)$ - [F,L]
</IfModule>

